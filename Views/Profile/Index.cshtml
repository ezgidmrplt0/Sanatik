@model Sanatik.Models.UserProfileViewModel
@using System.Security.Claims

@{
    ViewData["Title"] = "Profile";
}

<style>
    /* Modal Glass Effect for Photo Details */
    .modal-glass-container {
        background: rgba(15, 15, 15, 0.3) !important;
        backdrop-filter: blur(10px) saturate(180%);
        -webkit-backdrop-filter: blur(10px) saturate(180%);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        position: relative;
        overflow: hidden;
    }
    .modal-glass-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle at 30% 30%, rgba(0, 243, 255, 0.08), transparent 40%),
                    radial-gradient(circle at 70% 70%, rgba(255, 0, 150, 0.08), transparent 40%);
        animation: rotateBg 15s linear infinite;
        z-index: -1;
        pointer-events: none;
    }
    @@keyframes rotateBg {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .glass-transparent { background: transparent !important; }
    .glass-semi { background: rgba(0,0,0,0.2) !important; }
    .glass-border-bottom { border-bottom: 1px solid rgba(255,255,255,0.1) !important; }
    .glass-border-top { border-top: 1px solid rgba(255,255,255,0.1) !important; }
    .glass-border-left { border-left: 1px solid rgba(255,255,255,0.1) !important; }
    
    .form-control-glass {
        background: rgba(255, 255, 255, 0.05) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        color: white !important;
    }
    .form-control-glass:focus {
        background: rgba(255, 255, 255, 0.1) !important;
        box-shadow: 0 0 10px rgba(255,255,255,0.1);
    }
</style>

<div class="position-fixed top-0 start-0 w-100 h-100" style="z-index: -1;">
    <canvas id="star-canvas" style="width: 100%; height: 100%; display: block; background: radial-gradient(circle at center, #0f172a 0%, #000000 100%);"></canvas>
</div>

<div class="container text-white" style="padding-top: 50px;">
    
    <!-- Profile Header -->
    <!-- Profile Header -->
    <div class="modal-glass-container p-5 rounded-4 mb-5" style="border-radius: 20px;">
        <div class="row align-items-center">
            <div class="col-md-6 d-flex align-items-center gap-4">
                <div class="rounded-circle d-flex justify-content-center align-items-center shadow-lg" 
                     style="width: 120px; height: 120px; font-size: 3.5rem; color: white; background: linear-gradient(135deg, #333, #000); border: 1px solid rgba(255,255,255,0.2);">
                     @Model.UserName.Substring(0,1).ToUpper()
                </div>
                <div>
                    <h2 class="font-display mb-1 display-5">@@@Model.UserName</h2>
                    <span class="badge bg-transparent border border-secondary text-secondary font-mono rounded-pill mt-2">MEMBER</span>
                </div>
            </div>
            
            <div class="col-md-6 d-flex justify-content-md-end justify-content-center gap-5 mt-4 mt-md-0">
                <div class="text-center">
                    <h3 class="fw-bold mb-0 font-display">@Model.PostCount</h3>
                    <small class="text-white-50 font-mono" style="letter-spacing: 1px;">POSTS</small>
                </div>
                <div class="text-center cursor-pointer opacity-75 hover-opacity-100" data-bs-toggle="modal" data-bs-target="#followersModal">
                    <h3 class="fw-bold mb-0 font-display">@Model.FollowersCount</h3>
                    <small class="text-white-50 font-mono" style="letter-spacing: 1px;">FOLLOWERS</small>
                </div>
                <div class="text-center cursor-pointer opacity-75 hover-opacity-100" data-bs-toggle="modal" data-bs-target="#followingModal">
                    <h3 class="fw-bold mb-0 font-display">@Model.FollowingCount</h3>
                    <small class="text-white-50 font-mono" style="letter-spacing: 1px;">FOLLOWING</small>
                </div>
            </div>
            
            @if(Model.IsCurrentUser)
            {
               <div class="col-12 text-end mt-4 pt-3 border-top border-white border-opacity-10">
                   <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })" method="post" class="d-inline">
                       <button type="submit" class="btn btn-outline-danger px-5 rounded-pill btn-sm">LOGOUT</button>
                   </form>
               </div>
            }
            else
            {
               <div class="col-12 text-end mt-4 pt-3 border-top border-white border-opacity-10">
                   <button onclick="toggleFollowUser('@Model.UserId', this)" class="btn btn-sm rounded-pill px-5 @(Model.IsFollowing ? "btn-light" : "btn-outline-primary")">
                       @(Model.IsFollowing ? "FOLLOWING" : "FOLLOW")
                   </button>
               </div>
            }
        </div>
    </div>

    <!-- User Gallery Grid -->
    <div class="d-flex align-items-center mb-4">
        <h4 class="font-display m-0 text-white">GALLERY</h4>
        <div class="flex-grow-1 ms-3 border-bottom border-secondary border-opacity-25"></div>
    </div>
    <div class="row g-4">
        @if(Model.Photos.Count > 0)
        {
            @foreach(var photo in Model.Photos)
            {
                <div class="col-md-4 col-lg-3">
                    <div class="card bg-transparent border-0 h-100 photo-card" onclick="openModal(@photo.Id)" style="cursor: pointer; transition: transform 0.2s;">
                        <img src="@photo.ImagePath" class="card-img-top rounded-3" style="height: 250px; object-fit: cover; opacity: 0.9;" draggable="false">
                        <div class="card-body p-2 text-center">
                             <h6 class="text-white text-truncate">@photo.Title</h6>
                             <small class="text-secondary">@photo.UploadDate.ToString("yyyy.MM.dd")</small>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 py-5 text-center">
                 <!-- No uploads placeholder removed as per request -->
            </div>
        }
    </div>

</div>

<!-- Followers Modal -->
<div class="modal fade" id="followersModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content glass-message border-secondary text-white">
      <div class="modal-header border-bottom border-secondary border-opacity-25">
        <h5 class="modal-title font-display small">FOLLOWERS</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
         <ul class="list-group list-group-flush bg-transparent">
             @foreach(var user in Model.Followers)
             {
                 <li class="list-group-item bg-transparent text-white border-secondary border-opacity-10 d-flex justify-content-between align-items-center">
                     <div>
                        <i class="bi bi-person-circle me-2 text-secondary"></i> 
                        <a href="/Profile/Index/@user.UserId" class="text-white text-decoration-none">@@@user.UserName</a>
                     </div>
                     @if(User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier) != user.UserId)
                     {
                         <button onclick="toggleFollowUser('@user.UserId', this)" class="btn btn-sm rounded-pill @(user.IsFollowing ? "btn-light" : "btn-outline-primary")" style="font-size: 0.7rem; min-width: 90px;">
                            @(user.IsFollowing ? "FOLLOWING" : "FOLLOW")
                         </button>
                     }
                 </li>
             }
             @if(Model.Followers.Count == 0) { <li class="text-center text-muted small py-3">No followers.</li> }
         </ul>
      </div>
    </div>
  </div>
</div>

<!-- Following Modal -->
<div class="modal fade" id="followingModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content glass-message border-secondary text-white">
      <div class="modal-header border-bottom border-secondary border-opacity-25">
        <h5 class="modal-title font-display small">FOLLOWING</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
         <ul class="list-group list-group-flush bg-transparent">
             @foreach(var user in Model.Following)
             {
                 <li class="list-group-item bg-transparent text-white border-secondary border-opacity-10 d-flex justify-content-between align-items-center">
                     <div>
                        <i class="bi bi-person-circle me-2 text-secondary"></i> 
                        <a href="/Profile/Index/@user.UserId" class="text-white text-decoration-none">@@@user.UserName</a>
                     </div>
                     @if(User.FindFirstValue(System.Security.Claims.ClaimTypes.NameIdentifier) != user.UserId)
                     {
                         <button onclick="toggleFollowUser('@user.UserId', this)" class="btn btn-sm rounded-pill @(user.IsFollowing ? "btn-light" : "btn-outline-primary")" style="font-size: 0.7rem; min-width: 90px;">
                            @(user.IsFollowing ? "FOLLOWING" : "FOLLOW")
                         </button>
                     }
                 </li>
             }
             @if(Model.Following.Count == 0) { <li class="text-center text-muted small py-3">Not following anyone.</li> }
         </ul>
      </div>
    </div>
  </div>
</div>

<!-- Photo Detail Modal (Overlay) -->
<div id="detailModal" class="position-fixed top-0 start-0 w-100 h-100 justify-content-center align-items-center" 
     style="background: rgba(0,0,0,0.85); z-index: 2000; display: none; backdrop-filter: blur(5px);">
     
     <div class="modal-glass-container row g-0" style="width: 1000px; height: 650px; max-width: 95vw; max-height: 90vh; border-radius: 12px; overflow: hidden;">
         
         <!-- Image Section (Left - 65%) -->
         <div class="col-md-8 h-100 bg-black d-flex align-items-center justify-content-center p-0 position-relative">
             <button class="position-absolute start-0 top-50 translate-middle-y btn btn-link text-white p-2 ms-3 opacity-75 hover-opacity-100 rounded-circle" onclick="prevPhoto()" style="z-index: 10000; font-size: 2rem; background: rgba(0,0,0,0.5); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-chevron-left"></i></button>
             <button class="position-absolute end-0 top-50 translate-middle-y btn btn-link text-white p-2 me-3 opacity-75 hover-opacity-100 rounded-circle" onclick="nextPhoto()" style="z-index: 10000; font-size: 2rem; background: rgba(0,0,0,0.5); width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;"><i class="bi bi-chevron-right"></i></button>
             <img id="dm_img" src="" style="width: 100%; height: 100%; object-fit: contain; position: relative; z-index: 1;">
         </div>

         <!-- Details Section (Right - 35%) -->
         <div class="col-md-4 h-100 d-flex flex-column text-white glass-border-left" style="background: rgba(10,10,10,0.6);">
             
             <!-- Header -->
             <div class="p-3 glass-border-bottom">
                 <div class="d-flex justify-content-between align-items-start">
                     <div>
                         <h5 id="dm_title" class="font-display mb-1 text-wrap text-white" style="line-height: 1.2;">Title</h5>
                         <small class="text-secondary font-mono d-block mb-2">
                             by <span id="dm_user" class="text-white" style="position: relative; z-index: 10000; pointer-events: auto;">User</span>
                             <button id="btnFollow" onclick="actionFollow()" class="btn btn-sm btn-outline-primary rounded-pill py-0 px-2 ms-2" style="font-size: 0.65rem; display: none; position: relative; z-index: 10000; pointer-events: auto;">FOLLOW</button>
                         </small>
                     </div>
                     <button onclick="closeModal()" class="btn btn-link text-white p-0 opacity-75 hover-opacity-100" style="z-index: 10000; pointer-events: auto;"><i class="bi bi-x-lg" style="font-size: 1.5rem;"></i></button>
                 </div>
                 <p id="dm_desc" class="text-white-50 small mb-0 text-wrap" style="max-height: 60px; overflow-y: auto;">Description...</p>
             </div>

             <!-- Stats Bar -->
             <div class="p-3 glass-border-bottom d-flex justify-content-around align-items-center bg-transparent">
                 <div class="text-center cursor-pointer p-2" onclick="actionLike()" style="transition: transform 0.1s; pointer-events: auto;">
                     <i id="btnLikeIcon" class="bi bi-heart text-white" style="font-size: 1.8rem; display: block; margin-bottom: 5px;"></i>
                     <div class="small text-white-50" style="font-size: 0.7rem;"><span id="dm_likeCount">0</span> Likes</div>
                 </div>
                 <div class="text-center cursor-pointer p-2" onclick="actionFavorite()" style="transition: transform 0.1s; pointer-events: auto;">
                     <i id="btnFavIcon" class="bi bi-bookmark text-white" style="font-size: 1.8rem; display: block; margin-bottom: 5px;"></i>
                     <div class="small text-white-50" style="font-size: 0.7rem;"><span id="dm_favCount">0</span> Saves</div>
                 </div>
             </div>

             <!-- Comments Area -->
             <div class="flex-grow-1 overflow-auto p-3" id="commentsList" style="background: rgba(0,0,0,0.2);">
                 <!-- Comments injected JS -->
             </div>

             <!-- Input Area -->
             <div class="p-3 glass-border-top bg-transparent">
                 <div class="input-group">
                     <input type="text" id="commentInput" class="form-control form-control-sm bg-transparent text-white border-secondary" placeholder="Add a comment..." style="border-right: none;">
                     <button class="btn btn-sm btn-outline-secondary border-secondary text-white" onclick="postComment()" style="border-left: none;">POST</button>
                 </div>
             </div>

         </div>
     </div>
</div>

@section Scripts {
    <script src="~/js/bg-stars.js"></script>
    <script>
        // RAZOR SAFE VARIABLES
        var AT_SYMBOL = '@("@")'; 
        let currentPhotoId = 0;
        let currentPhotoUserId = "";
        
        // List of Photo IDs for Navigation
        var photoIds = [@string.Join(",", Model.Photos.Select(p => p.Id))];
        let currentIndex = -1;

        function openModal(id) {
            console.log("openModal called with id:", id);
            currentPhotoId = id;
            currentIndex = photoIds.indexOf(id);

            var modal = document.getElementById('detailModal');
            modal.style.display = 'flex';
            
            // UI References
            var imgEl = document.getElementById('dm_img');
            var titleEl = document.getElementById('dm_title');
            var userEl = document.getElementById('dm_user');
            var followBtn = document.getElementById('btnFollow');
            var descEl = document.getElementById('dm_desc');
            var likeCountEl = document.getElementById('dm_likeCount');
            var favCountEl = document.getElementById('dm_favCount');
            
            // Set loading state
            if(imgEl) { imgEl.style.opacity = '0.5'; imgEl.src = ''; }
            if(titleEl) titleEl.innerText = 'Loading...';
            if(followBtn) followBtn.style.display = 'none';
            
            // Fetch Data
            fetch('/Photos/GetPhotoDetails?id=' + id)
                .then(response => {
                    if (!response.ok) throw new Error("HTTP error " + response.status);
                    return response.json();
                })
                .then(data => {
                    // Standardize data
                    var title = data.title || "Untitled";
                    var imagePath = data.imagePath || "";
                    var userName = data.userName || "Unknown";
                    var description = data.description || "No description.";
                    var likeCount = data.likeCount ?? 0;
                    var favCount = data.favoriteCount ?? 0;
                    var isLiked = data.isLiked ?? false;
                    var isFavorited = data.isFavorited ?? false;
                    var comments = data.comments || [];
                    var isFollowing = data.isFollowing ?? false;
                    currentPhotoUserId = data.photoUserId || "";

                    if(imgEl) { 
                        imgEl.src = imagePath; 
                        imgEl.onload = function() { this.style.opacity = '1'; };
                    }
                    if(titleEl) titleEl.innerText = title;
                    
                    if(userEl) {
                         let safeName = userName.includes(AT_SYMBOL) ? userName.split(AT_SYMBOL)[0] : userName;
                         // Make username clickable
                         if(currentPhotoUserId) {
                             userEl.innerHTML = `<a href="/Profile/Index/${currentPhotoUserId}" class="text-white text-decoration-none" style="transition: color 0.2s;" onmouseover="this.className='text-info text-decoration-none'" onmouseout="this.className='text-white text-decoration-none'">${AT_SYMBOL}${safeName.toUpperCase()}</a>`;
                         } else {
                             userEl.innerText = AT_SYMBOL + safeName.toUpperCase();
                         }
                    }
                    
                    if(followBtn && currentPhotoUserId) {
                        followBtn.style.display = 'inline-block';
                        updateFollowButton(isFollowing);
                    } else {
                        followBtn.style.display = 'none';
                    }
                    
                    if(descEl) descEl.innerText = description;
                    if(likeCountEl) likeCountEl.innerText = likeCount;
                    if(favCountEl) favCountEl.innerText = favCount;
                    
                    updateIcon('btnLikeIcon', isLiked, 'bi-heart-fill text-danger', 'bi-heart text-white');
                    updateIcon('btnFavIcon', isFavorited, 'bi-bookmark-fill text-primary', 'bi-bookmark text-white');

                    const list = document.getElementById('commentsList');
                    if(list) {
                        list.innerHTML = '';
                        if(comments.length > 0) {
                            comments.forEach(c => {
                                var cUser = c.userName || "user";
                                var cContent = c.content || "";
                                var cTime = c.timeAgo || "";
                                let cSafeName = cUser.includes(AT_SYMBOL) ? cUser.split(AT_SYMBOL)[0] : cUser;

                                const div = document.createElement('div');
                                div.className = 'mb-3 d-flex flex-column align-items-start';
                                div.innerHTML = `
                                    <div class="glass-message p-2 px-3 rounded-3" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <span class="fw-bold fs-6 text-info me-2">${AT_SYMBOL}${cSafeName.toUpperCase()}</span>
                                            <span class="text-white-50 small font-mono" style="font-size: 0.65rem;">${cTime}</span>
                                        </div>
                                        <p class="mb-0 small" style="line-height: 1.4; color: #ffffff !important; font-weight: 500;">${cContent}</p>
                                    </div>
                                `;
                                list.appendChild(div);
                            });
                        } else {
                            list.innerHTML = '<div class="text-center text-muted small mt-5">No comments yet.</div>';
                        }
                    }
                })
                .catch(err => {
                    console.error("Fetch error:", err);
                    alert("Error loading photo details.");
                });
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        function updateIcon(elId, isActive, activeClass, inactiveClass) {
            const el = document.getElementById(elId);
            if(el) {
                if(isActive) {
                    el.className = 'bi ' + activeClass;
                } else {
                    el.className = 'bi ' + inactiveClass;
                }
            }
        }

        function updateFollowButton(isFollowing) {
            const btn = document.getElementById('btnFollow');
            if(isFollowing) {
                btn.innerText = "UNFOLLOW";
                btn.className = "btn btn-sm btn-light rounded-pill py-0 px-2 ms-2";
            } else {
                btn.innerText = "FOLLOW";
                btn.className = "btn btn-sm btn-outline-primary rounded-pill py-0 px-2 ms-2";
            }
        }

        function actionFollow() {
             if(currentPhotoUserId) {
                 $.post('/Photos/ToggleFollow', { followeeId: currentPhotoUserId }, function(res) {
                     if(res.success) updateFollowButton(res.isFollowing);
                 });
             }
        }

        function actionLike() {
             $.post('/Photos/AjaxLike', { photoId: currentPhotoId }, function(res) {
                 if(res.success) {
                     updateIcon('btnLikeIcon', res.isLiked, 'bi-heart-fill text-danger', 'bi-heart text-white');
                     document.getElementById('dm_likeCount').innerText = res.count;
                 }
             });
        }

        function actionFavorite() {
             $.post('/Photos/ToggleFavorite', { photoId: currentPhotoId }, function(res) {
                 if(res.success) {
                      updateIcon('btnFavIcon', res.isFavorited, 'bi-bookmark-fill text-primary', 'bi-bookmark text-white');
                      document.getElementById('dm_favCount').innerText = res.count;
                 }
             });
        }

        function postComment() {
            const input = document.getElementById('commentInput');
            const val = input.value;
            if(!val) return;

            $.post('/Photos/AjaxComment', { photoId: currentPhotoId, content: val }, function(res) {
                if(res.success) {
                     input.value = '';
                     const list = document.getElementById('commentsList');
                     if(list.innerText.includes('No comments yet')) list.innerHTML = '';

                     const div = document.createElement('div');
                     div.className = 'mb-3 d-flex flex-column align-items-start';
                     div.innerHTML = `
                        <div class="glass-message p-2 px-3 rounded-3" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <span class="fw-bold fs-6 text-info me-2">${AT_SYMBOL}${res.userName.toUpperCase()}</span>
                                <span class="text-white-50 small font-mono" style="font-size: 0.65rem;">${res.timeAgo}</span>
                            </div>
                            <p class="mb-0 small" style="line-height: 1.4; color: #ffffff !important; font-weight: 500;">${res.content}</p>
                        </div>
                     `;
                     list.insertBefore(div, list.firstChild);
                }
            });
        }

        function toggleFollowUser(userId, btn) {
            $.post('/Photos/ToggleFollow', { followeeId: userId }, function(res) {
                if(res.success) {
                    if(res.isFollowing) {
                        btn.innerText = "FOLLOWING";
                        btn.className = "btn btn-sm btn-light rounded-pill";
                    } else {
                        btn.innerText = "FOLLOW";
                        btn.className = "btn btn-sm btn-outline-primary rounded-pill";
                    }
                }
            });
        }
        function prevPhoto() {
            if(currentIndex > 0) {
                currentIndex--;
                openModal(photoIds[currentIndex]);
            }
        }

        function nextPhoto() {
            if(currentIndex < photoIds.length - 1) {
                currentIndex++;
                openModal(photoIds[currentIndex]);
            }
        }
    </script>
}
